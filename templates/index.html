<!doctype html>
<html lang="en"><head>
    <!-- Bootstrap-required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        
    <title>id:xtable</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"  crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha256-bQmrZe4yPnQrLTY+1gYylfNMBuGfnT/HKsCGX+9Xuqo=" crossorigin="anonymous"></script>

    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jplayer/2.9.2/jplayer/jquery.jplayer.min.js'></script>
    <!--script type='text/javascript' src='/static/js/sound.js'></script>-->

</head><body>

<!-- CSS styling -->
<style type='text/css'>
:root {
    --main-bg-color: midnightblue;
    --main-fg-color: white;
}
body, a {
    font-family: Sans-Serif;
    color: white !important;
    background-color: var(--main-bg-color);
}
a {
    text-decoration: none;
}
button {
    border-radius: 6px;
}
input, textarea {
    font-size: 20px;
    font-family: Courier;
    width: 100%;
    color: black;
    background-color: white;
}
textarea {
    font-size: 20px;
    height: 100px;
}
select {
    height: 50px;
}
.checkbox {
    white-space: nowrap;
    display: inline-block;
}
.round {
    border: 2px solid white;
    border-radius: 10px;
}
.bid_button {
    width: 20%;
    height: 4vh;
    font-size: 2vh;
    text-align: center;
    float: left;
    color: black;
    padding-left: 5px;
    padding-right: 5px;
    padding-top: 0.5vh;
    padding-bottom: 1vh;
    background-color: white;
    border: 1px solid var(--main-bg-color);
    border-radius: 5px;
    cursor: pointer;
}
.bid_button:hover {
    background-color: mediumspringgreen;
}
.disabled_bid {
    background-color: gray;
}
.alert_button {
    color: red;
}
.alert_button_highlight {
    color: white;
    background-color: red;
}
.announce_button {
    color: blue;
}
.announce_button_highlight {
    color: white;
    background-color: blue;
}
#bid_panel {
    height: 35.25vh;
    padding: 0px -1px 0px -1px;
    font-size: 2vh;
    text-align: left;
    overflow: hidden;
    border: 1px solid slategray;
    background-color: black;
    margin-top: -3vh;
}
.log, .chat {
    height: 25vh;
    overflow-y: scroll;
    /* background-color: black; */
    font-size: 15px;
}
.card_container {
    margin-left: 5px;
    margin-top: 5px;
}
.played_trick {
    height: 8vh;
    position: relative;
    float: left;
    background-color: transparent;
}
#tricks_played.first-child {
    opacity: .99;
}
.card {
    height: 11.5vh;
    float: left;
    background-color: transparent;
}
.card:hover {
    height: 15vh;
}
.bigcard {
    height: 18vh;
}
.bigcard:hover {
    height: 21vh;
}
.card_right {
    height: 10vh;
    float: right;
}
.card_playable {
    cursor: pointer;
}
.card_move_up {
    margin-top: -10vh;
}
.card_move_right {
    margin-left: 10vh;
}
.card_move_left {
    margin-right: 12vh;
}
.trick_up {
    margin-top: -2vh;
}
.overlap {
    margin-left: -2.5vw;
}
.overlap_bid {
    margin-left: -4vh;
}
.overlap_played_tricks {
    margin-left: -1.25vw;
}
.overlap_vert {
    margin-top: -7vh;
}
.rotate90 {
    transform: rotate(90deg);
}
.rotate270 {
    transform: rotate(270deg);
}
.top_bid {
    margin-top: -3vh
}
.card_centered {
    display: block;
    margin: auto;
    margin-left: auto;
    margin-right: auto;
}
.panel {
    margin: 10px 10px 10px 10px;
    padding: 10px 10px 10px 10px;
    border-radius: 10px;
}
.info_panel {
    /*margin: 10px -5px 0px -5px;*/
    padding: 0px 10px 5px 10px;
    font-size: 2vh;
    text-align: left;
    height: 17vh;
    overflow: hidden;
    margin: 0px -13px 0px -13px;
}
.info_panel_header {
    text-align: center;
    color: var(--main-bg-color);
    background-color: white;
}
.footer {
    font-size: 15px;
    margin: 1em 0 0 0;
}
.red {
    background-color: red;
}
.red_text {
    color: red;
}
.black_text {
    color: black;
}
.white_text {
    color: white;
}
.hand {
    /* padding: 10px 10px 10px 10px; */
    height: 17vh;
}
.yo {
    background-color: mediumspringgreen;
}
.active_hand {
    background-color: mediumspringgreen;
}
.approval_button {
    width: 100%;
    background-color: mediumspringgreen;
    border: none;
    color: white;
    /* padding: 15px 32px; */
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
}
.ctr {
    width: 100%;
    text-align: center;
}
#header {
    height: 6vh;
    padding-top: 5px;
    background-color: black;
    font-size: 20px;
}
#footer {
    height: 5vh;
    background-color: black;
    font-size: 2.5vh;
}
.copyright {
    margin-top: 5px;
    font-size: 10px;
}
#top_hand, #bottom_hand, #top_left_spacer, #top_right_spacer {
    height: 17vh;
    text-align: center;
    margin-top: .5vh;
}
#left_hand, #right_hand {
    text-align: center;
}
#middle_panel {
    margin-top: 0.5vh;
}
.hand_header {
    color: white;
    background-color: var(--main-bg-color);
    border-radius: 6px 6px 0px 0px;
    width: 100%;
    text-align: center;
}
.hand_header_active {
    color: var(--main-bg-color);
    background-color: white;
}
#stage {
    height: 53vh;
}
#top_play, #bottom_play {
    height: 9.5vh;
    margin: 5px;
    padding: 5px;
}
#center_stage {
    height: 35vh;
}
.cardplay {
    height: 11vh;   /* 1/3 of center_stage */
}
#center_header, #center_footer {
    text-align: center;
}
#right_header, #right_footer {
    text-align: right;
}
.bid_card {
    height: 10vh;
    width: 7vh;
    text-align: center;
    font-size: 2vh;
    padding-top: 0.5vh;
    background-color: white;
    border-radius: 4px;
    padding-left: 5px;
    padding-right: 5px;
    margin-right: 5px;
    margin-bottom: 5px;
    border: 1px solid black;
}
.bid_card_alerted {
    border: 2px solid red;
}
.bid_card_announced {
    border: 2px solid blue;
}
.bid_card_border {
    border: 2px solid darkgray;
}
.bid_card_round {
    border-radius: 4px;
}
.red_background {
    background-color: red;
}
.blue_background {
    background-color: blue;
}
.green_background {
    background-color: green;
}
.claim_window {
    padding: 5px;
}
.scores {
    margin-top: -5vh;
    height: 40vh;
}
.bid_card_bot {
    margin-top: -4vh;
}
.score_table_header {
    font-weight: bold;
    text-align: center;
}
.round_scores {
    margin-top: 10px;
}
#background_color_picker div {
    width: 30px;
    height: 4vh;
    color: white;
}
#background_color_picker_button {
    background-color: green;
    border: 1px solid white;
    border-radius: 3px;
    float: right
}
.right {
    float: right;
}
.left {
    float:left;
}
.modal-content {
    border: 2px solid limegreen;
    border-radius: 10px;
}
.modal-content, .modal-title {
    color: black;
    background-color: white;
}
.modal-backdrop, .modal-backdrop.in {
    opacity: 0.3 !important;
}
.dropdown-item {
    color: black !important;
}
.dropdown-item:hover {
    color: white !important;
    background-color: var(--main-bg-color);
}
#left_hand_bid_table {
    color: black;
    background-color: white;
}
.bid_table_cell {
    text-align: center;
    margin: 2px;
    border-radius: 4px;
}
.alt:nth-child(odd) {
    background-color: gainsboro;
}
.bid_table_alt:nth-child(odd) {
    background-color: gainsboro;
}
.bid_table_alt:nth-child(even) {
    background-color: silver;
}

</style>

<!-- HTML page structure with Vue v-decorations -->
<div id='app' class='container-fluid'>
    <div id='header' class='row'>
        <div id='left_header' class='col'>
            <span v-if='show_debug_menu' class='btn-group btn-group-sm'>
                <button type='button' class='btn btn-secondary btn-sm' v-on:click='toggleDebugMenu'>&times;</button>
                <button type='button' class='btn btn-secondary btn-sm' 
                    v-if='!autoplay' v-on:click='autoplay=true'>Auto</button>
                <button type='button' class='btn btn-secondary btn-sm' 
                    v-else v-on:click='autoplay=false'>No Auto</button>
                <button type='button' class='btn btn-danger btn-sm' v-on:click='restartPlay'>Reset</button>
                <button type='button' class='btn btn-danger btn-sm' v-on:click='goToLobby'>Lobby</button>
                <button type='button' class='btn btn-secondary btn-sm' v-on:click='logOut'>Logout</button>
            </span>
            <span v-else v-on:click='toggleDebugMenu'>ID Bridge</span>
        </div>
        <div id='center_header' class='col-6'>
<!--
            <div v-if='approval_alert_text' class='yo' v-on:click='approve'>
                <span>{{approval_alert_text}}</span>
            </div>
            <div v-else>
                {{status}}
            </div>
-->
            <div>
                {{status}}
            </div>
        </div>
        <div id='right_header' class='col'>
            <div v-if='late_play'>
                <span class='red white_text'>LATE PLAY</span>
            </div>
<!--
            <div v-if='0' class='btn-group btn-group-sm'>
                <button type='button' class='btn btn-secondary btn-sm' v-on:click='logOut'>Logout</button>
            </div>
-->
        </div>
    </div>

    <div id='top_hand_panel' class='row'>
        <div id='top_left_spacer' class='col'>
            <div class='info_panel round' v-if='"cards" in hand'>
                <div class='row info_panel_header'>
                    <div class='col'>
                        <span v-if='autoplay' v-on:click='autoplay=0'>Auto</span>
                        <span>Player: {{name}} @ {{seat}}</span>
                    </div>
                </div>
                <div class='row'>
                    <div class='col'>Table: {{hand.table_number + 1}}</div>
                    <div class='col'>Round: {{hand.round_number + 1}}</div>
                    <div class='col'>Board: {{hand.board_number + 1}}</div>
                </div>
                <div class='row' v-if='("pairs" in hand) && ("ns" in hand.pairs)'>
                    <div class='col'>NS: Pair {{1+hand.pairs.ns}}</div>
                    <div class='col'>EW: Pair {{1+hand.pairs.ew}}</div>
                    <div class='col'>Vul: {{hand.hand_vulnerable}}</div>
                </div>
            </div>
        </div>
        <div id='top_hand' class='col-6 round'  v-bind:class='{active_hand: (show_dummy=="top") && dummy_to_play}'>
            <div class='row'>
                <div v-if='dummy_to_play' class='col'>The play is to you in the dummy.  Please click a card.</div>
                <div v-else='player_names.top.name' class='col hand_header'
                    v-bind:class='{hand_header_active: player_names.top.seat == current_player}'>
                    {{player_names.top.name}} playing {{player_names.top.seat}}
                    <span v-if='player_names.top.bot'>&#9889;</span>
                </div>
            </div>
            <div v-if='(dummyhand.length > 0) && (show_dummy=="top")' class='hand' id='dummyhand'>
                <div>
                    <div class='card_container'>
                        <span v-for="(card, cardindex) in dummyhand">
                            <img class='card card_playable' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)' v-on:click='confirmPlayDummyCard(cardindex)'>
                        </span>
                    </div>
                </div>
            </div>
            <div v-else-if='(claimhand.length > 0) && (show_claimhand=="top") && show_claim' class='hand' id='dummyhand'>
                <div>
                    <div class='card_container'>
                        <span v-for="(card, cardindex) in claimhand">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </span>
                    </div>
                </div>
            </div>
            <div v-else-if='(declarerhand.length > 0) && (show_declarer)' class='hand' id='declarerhand'>
                <div>
                    <div class='card_container'>
                        <span v-for="(card, cardindex) in declarerhand">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div id='top_right_spacer' class='col'>
            <div class='info_panel round'>
                <div class='row info_panel_header'>
                    <div class='col'>
                        Contract
                    </div>
                </div>
                <div class='row'>
                    <div class='col'>Dealer: {{hand.dealer}}</div>
                    <div class='col'>Contract: {{hand.contract}}</div>
                </div>
                <div class='row'>
                    <div class='col'>Declarer: {{hand.declarer}}</div>
                    <div class='col' v-if='hand.vulnerable'>Vulnerable</div>
                </div>
                <div class='row'>
                    <div class='col' v-if='hand.doubled'>Doubled</div>
                    <div class='col' v-if='hand.redoubled'>Redoubled</div>
                </div>
                <div class='row'>
                    <div class='col'>NS tricks: {{hand.NStricks_won}}</div>
                    <div class='col'>EW tricks: {{hand.EWtricks_won}}</div>
                </div>
            </div>
        </div>
    </div>
    <div id='middle_panel' class='row'>
        <div v-if='bidding' id='left_hand_bid_table' class='col round'>
            <div class='row'>
                <span class='ctr hand_header'>Bid Table</span>
            </div>
            <div class='row ctr'>
                <div class='col col-sm'>W</div>
                <div class='col col-sm'>N</div>
                <div class='col col-sm'>E</div>
                <div class='col col-sm'>S</div>
            </div>
            <div v-for='(bid, bidindex) in bid_table' class='row bid_table_alt'>
                <div v-for='(direction, directionindex) in ["W","N","E","S"]' class='col col-sm bid_table_cell'>
                    <div v-if='!bid[direction]'>&nbsp;</div>
                    <div v-else v-html='bid[direction].bid.bid_data.html_label'
                        class='bid_card_round'
                        data-toggle='tooltip'
                        v-bind:data-title='bid[direction].bid.alert || bid[direction].bid.announce || ""'
                        v-bind:style='{
                            color: bid[direction].bid.bid_data.color,
                            backgroundColor: bid[direction].bid.bid_data.background,
                        }'
                        v-bind:class='{
                            bid_card_alerted: "alert" in bid[direction].bid,
                            bid_card_announced: "announce" in bid[direction].bid,
                            bid_card_border: !("alert" in bid[direction].bid) && !("announce" in bid[direction].bid)
                        }'>
                    </div>
                </div>
            </div>
        </div>
        <div v-else id='left_hand' class='col round' v-bind:class='{active_hand: (show_dummy=="left") && dummy_to_play}'>
            <div class='row'>
                <div v-if='player_names.left.name' class='col hand_header'                    
                     v-bind:class='{hand_header_active: player_names.left.seat == current_player}'>
                    {{player_names.left.name}} playing {{player_names.left.seat}}
                    <span v-if='player_names.left.bot'>&#9889;</span>
                </div>
            </div>
            <div v-if='(dummyhand.length > 0) && (show_dummy=="left")' class='hand' id='dummyhand'>
                <div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_dummyhand[3]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_dummyhand[2]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_dummyhand[1]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_dummyhand[0]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else-if='(left_claimhand.length > 0) && (show_claimhand=="left") && show_claim' class='hand' id='claimhand'>
                <div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_claimhand[3]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_claimhand[2]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_claimhand[1]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container'>
                        <div v-for="(card, cardindex) in left_claimhand[0]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id='stage' class='col-6'>
            <div>
                <div id='top_stage_panel' class='row'>
                    <div id='tl_stage_spacer' class='col'>&nbsp;</div>
                    <div id='top_play' class='col-6'>
                        <div v-if='bids.top.length'>
                            <span v-for='(bid, index) in bids.top'>
                                <span v-html='bid.bid.bid_data.html_label' class='bid_card right top_bid rotate90' v-bind:class='{overlap_bid: index>=0}'
                                    v-bind:style='{
                                        color: bid.bid.bid_data.color,
                                        backgroundColor: bid.bid.bid_data.background
                                    }'>
<!--
                                    v-bind:class='{
                                        red_text: bid.bid.bid_data.color=="red", 
                                        black_text:bid.bid.bid_data.color=="black",
                                        white_text:bid.bid.bid_data.color=="white",
                                        red_background: bid.bid.bid_data.background == "red",
                                        blue_background: bid.bid.bid_data.background == "blue",
                                        green_background: bid.bid.bid_data.background == "green"
                                    }'>
-->
                                </span>
                            </span>
                        </div>
                    </div>
                    <div id='tr_stage_spacer' class='col'>&nbsp;</div>
                </div>
                <div id='middle_play_panel' class='row'>
                    <div id='left_play' class='col'>
                        <div v-if='bids.left.length'>
                            <span v-for='(bid, index) in bids.left'>
                                <span v-html='bid.bid.bid_data.html_label' class='bid_card left'
                                    data-toggle='tooltip' 
                                    v-bind:data-title='bid.bid.alert || bid.bid.announce || ""'
                                    v-bind:style='{
                                        color: bid.bid.bid_data.color,
                                        backgroundColor: bid.bid.bid_data.background
                                    }'
                                    v-bind:class='{
                                        bid_card_alerted: "alert" in bid.bid,
                                        bid_card_announced: "announce" in bid.bid,
                                        overlap_vert: index>0
                                    }'>
                                </span>
                            </span>
                        </div>
                    </div>
                    <div id='center_stage' class='col-8'>
                        <div v-if='show_scores' v-on:click='approveHand' class='scores info_panel round'>
                            <div>
                                <div class='row info_panel_header'>
                                    <div class='col'>Table Results</div>
                                </div>
                                <div class='row'>
                                    <div class='col'>Board</div>
                                    <div class='col'>Contract</div>
                                    <div class='col'>Vul</div>
                                    <div class='col'>NS</div>
                                    <div class='col'>EW</div>
                                </div>
                                <div v-for='score in table_results' class='row'>
                                    <div class='col'>{{score.board_num + 1}}</div>
                                    <div class='col'>{{score.contract}} ({{score.declarer}})</div>
                                    <div class='col'>{{score.vulnerable}}</div>
                                    <div class='col'>{{score.scoreNS}}</div>
                                    <div class='col'>{{score.scoreEW}}</div>
                                </div>
                                <div class='row'>
                                    <div class='col'>&nbsp;</div>
                                </div>
                                <div class='row'>
                                    <div class='round approval_button'>Hand complete.  Click here to continue.</div>
                                </div>
                            </div>
                        </div>
                        <div v-else-if='show_bidding' id='bid_panel' class='round'>
                            <div class='info_panel_header yo'>
                                <span>Your bid, {{name}}.</span>
                            </div>
                            <div>
                                <span v-for="(button, index) in bid_buttons">
                                    <div v-on:click='confirmBid(index)' class='bid_button'
                                        v-bind:class='{disabled_bid: button.disabled}'>
                                        <span v-html='button.html_label' 
                                            v-bind:class='{red_text: button.color=="red", black_text: button.color=="black"}'></span>
                                    </div>
                                </span>
                                <span>
                                    <div v-on:click='toggleAlert' class='bid_button alert_button'
                                        data-toggle='tooltip' data-placement='top'
                                        title='To Alert your next bid, click ALRT'
                                        v-bind:class='{alert_button_highlight: alert_bid}'>
                                        <span>ALRT</span>
                                    </div>
                                    <div v-on:click='toggleAnnounce' class='bid_button announce_button'
                                        data-toggle='tooltip' data-placement='top'
                                        title='To Announce your next bid, click ANN'
                                    v-bind:class='{announce_button_highlight: announce_bid}'>
                                        <span>ANN</span>
                                    </div>
                                </span>
                            </div>
                        </div>

<!--
                        <div v-else-if='show_claim' class='claim_window round' v-on:click='acceptClaim'>
                            <span class='approval_button'>Claim by {{claim.name}}</span>
                            <p>
                                {{claim.name}} sitting {{claim.seat}} 
                                claims {{claim.tricks_claimed}} tricks 
                                and concedes {{claim.tricks_conceded}}.
                            </p>
                            <p>{{claim.name}}'s Explanation: {{claim.explanation}}</p>
                            <div v-if='show_claim_buttons'>
                                <p>Click Accept or Dispute to continue.</p>
                                <div class='col-offset-6 col-12 btn-group btn-group-sm'>
                                    <button type='button' class='btn btn-success' v-on:click='acceptClaim'>Accept</button>
                                    <button type='button' class='btn btn-danger' v-on:click='disputeClaim'>Dispute</button>
                                </div>
                            </div>
                            <div v-else>
                                <p>Waiting for claim resolution...</p>
                            </div>
                        </div>
-->
                        <div v-else-if='show_cards_played' class='panel'>
                            <div class='row cardplay'>
                                <div class='col'>&nbsp;</div>
                                <div id='top_card' class='col card_move_up'>
                                    <img v-if='"top" in cards_played'
                                        class='card card_centered bigcard' :src='getImgUrl(cards_played.top.cardindex)'/>
                                </div>
                                <div class='col'>&nbsp;</div>
                            </div>
                            <div class='row cardplay'>
                                <div id='left_card' class='col card_move_up card_move_right'>
                                    <img v-if='"left" in cards_played'
                                        class='card rotate90 bigcard' :src='getImgUrl(cards_played.left.cardindex)'/>
                                </div>
                                <div class='col ctr'>
                                    <div class='row'>
                                        <div class='col'>&nbsp;</div>
                                    </div>
                                    <div class='row'>
                                        <div class='col'>&nbsp;</div>
                                    </div>
<!--
                                    <div class='row'>
                                        <div class='col ctr'>{{status}}</div>
                                    </div>
-->
                                </div>
                                <div id='right_card' class='col card_move_up card_move_left'>
                                    <img v-if='"right" in cards_played'
                                        style='float:right'
                                        class='card rotate90 bigcard' :src='getImgUrl(cards_played.right.cardindex)'/>
                                </div>
                            </div>
                            <div class='row cardplay'>
                                <div class='col'>&nbsp;</div>
                                <div id='bottom_card' class='col card_move_up'>
                                    <img v-if='"bottom" in cards_played'
                                        v-on:click='showing_last_card ? hideLastCard() : 0'
                                        class='card card_centered bigcard' :src='getImgUrl(cards_played.bottom.cardindex)'/>
                                </div>
                                <div class='col'>&nbsp;</div>
                            </div>
                        </div>
                        <div v-else class='ctr'>
                            {{status}}
                        </div>
                    </div>
                    <div id='right_play' class='col'>
                        <div v-if='bids.right.length'>
                            <span v-for='(bid, index) in bids.right' class='right'>
                                <span v-html='bid.bid.bid_data.html_label' class='bid_card right'
                                    data-toggle='tooltip' 
                                    v-bind:data-title='bid.bid.alert || bid.bid.announce || ""'
                                    v-bind:style='{
                                        color: bid.bid.bid_data.color,
                                        backgroundColor: bid.bid.bid_data.background
                                    }'
                                    v-bind:class='{
                                        bid_card_alerted: "alert" in bid.bid,
                                        bid_card_announced: "announce" in bid.bid,
                                        overlap_vert: index>0
                                    }'>
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
                <div id='bottom_stage_panel' class='row'>
                    <div id='bl_stage_spacer' class='col'>&nbsp;</div>
                    <div id='bottom_play' class='col-6'>
                        <div id='tricks_played' v-if='tricks_played.length' class='trick_up'>
                            <img v-for='(trick, trickindex) in tricks_played'
                                v-on:click='showLastCard(trickindex)'
                                v-bind:style='{zIndex: 1000+trickindex}'
                                class='played_trick' v-bind:class='{
                                    rotate90: !((trick.winner == seat) || (trick.winner==across_table[seat])), 
                                    overlap_played_tricks: trickindex>0}'
                                v-bind:src='getCardBackImg()'/>
                        </div>
                        <div v-else-if='bids.bottom.length'>
                            <span v-for='(bid, index) in bids.bottom'>
                                <span v-html='bid.bid.bid_data.html_label' class='bid_card left bid_card_bot rotate270'
                                    data-toggle='tooltip' 
                                    v-bind:data-title='bid.bid.alert || bid.bid.announce || ""'
                                    v-bind:style='{
                                        color: bid.bid.bid_data.color,
                                        backgroundColor: bid.bid.bid_data.background
                                    }'
                                    v-bind:class='{
                                        bid_card_alerted: "alert" in bid.bid,
                                        bid_card_announced: "announce" in bid.bid,
                                        overlap_bid: index>=0
                                    }'>
                                </span>
                            </span>
                        </div>
                    </div>
                    <div id='br_stage_spacer' class='col'>
                        <button id='claim_button' v-if='((seat != hand.dummyseat) && hand.declarer)' 
                            type='button' class='claim btn btn-secondary'
                            v-on:click='confirmClaim'>
                            Claim
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div id='right_hand' class='col round' v-bind:class='{active_hand: (show_dummy=="right") && dummy_to_play}'>
            <div class='row'>
                <div v-if='player_names.right.name' class='col hand_header'
                    v-bind:class='{hand_header_active: player_names.right.seat == current_player}'>
                    {{player_names.right.name}} playing {{player_names.right.seat}}
                    <span v-if='player_names.right.bot'>&#9889;</span>
                </div>
            </div>
            <div v-if='(dummyhand.length > 0) && (show_dummy=="right")' class='hand' id='dummyhand'>
                <div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_dummyhand[0]" class='right'>
                            <img class='card right' v-bind:class='{overlap: cardindex>0}' 
                                v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_dummyhand[1]" class='right'>
                            <img class='card right' v-bind:class='{overlap: cardindex>0}' 
                            v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_dummyhand[2]" class='right'>
                            <img class='card right' v-bind:class='{overlap: cardindex>0}' 
                            v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_dummyhand[3]" class='right'>
                            <img class='card right' v-bind:class='{overlap: cardindex>0}' 
                            v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else-if='show_claim && (show_claimhand=="right") && (right_claimhand.length > 0)' class='hand' id='claimhand'>
                <div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_claimhand[0]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' 
                            v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_claimhand[1]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' 
                            v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_claimhand[2]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' 
                            v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                    <div class='row card_container justify-content-end'>
                        <div v-for="(card, cardindex) in right_claimhand[3]">
                            <img class='card' v-bind:class='{overlap: cardindex>0}' 
                                v-bind:style='{zIndex: -cardindex+100}' :src='getImgUrl(card)'>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='bottom_hand_panel' class='row'>
        <div id='bottom_left_spacer' class='col'>&nbsp;</div>
        <div id='bottom_hand' class='col-6 round' v-bind:class='{active_hand: to_play}'>
            <div class='row'>
                <div v-if='to_play' class='col'>The play is to you, {{player_names.bottom.name}}.  Please click a card.</div>
                <div v-else='player_names.bottom.name' class='col hand_header'
                    v-bind:class='{hand_header_active: player_names.bottom.seat == current_player}'>
                    {{player_names.bottom.name}} playing {{player_names.bottom.seat}}
                    <span v-if='player_names.bottom.bot'>&#9889;</span>
                </div>
            </div>
            <div v-if='myhand.length > 0' id='myhand' class='hand'>
                <div>
                    <div class='card_container'>
                            <img v-for="(card, cardindex) in myhand"
                                class='card card_playable' v-bind:class='{overlap: cardindex>0}' 
                                :src='getImgUrl(card)' 
                                v-on:click='confirmPlayCard(cardindex)'/>
                    </div> 
                </div>
            </div>
        </div>
        <div id='bottom_right_spacer' class='col'>
            <div class='btn-group btn-group-sm'>
                <span class="dropdown">
                    <button type='button' class="btn btn-secondary btn-sm dropdown-toggle" id="chatMenuToggle" data-toggle="dropdown">Chat...</button>
                    <span class="dropdown-menu">
                        <button type='button' class="dropdown-item" v-on:click='showChat'>
                            Chat with Table
                        </button>
                        <button type='button' class="dropdown-item" v-on:click='showOpponentsChat'>
                            Chat with Opponents
                        </button>
                    </span>
                </span>
                <button type='button' class='btn btn-secondary btn-sm' v-on:click='showConventionCard'>CC</button>
                <button type='button' class='btn btn-secondary btn-sm' v-on:click='callDirector'>Call TD</button>
                <span class="dropdown">
                    <button type='button' class="btn btn-secondary btn-sm dropdown-toggle" id="settingsMenuToggle" data-toggle="dropdown">Settings...</button>
                    <span class="dropdown-menu">
                        <button type='button' class="dropdown-item" v-on:click='toggleTwoClickBids' href="#">
                            <span v-if='two_click_bids'>&#9746;</span>
                            <span v-else>&#9744;</span>
                            Two Click Bids
                        </button>
                        <button class="dropdown-item" v-on:click='toggleTwoClickPlays' href="#">
                            <span v-if='two_click_plays'>&#9746;</span>
                            <span v-else>&#9744;</span>
                            Two Click Plays
                        </button>
                        <button class="dropdown-item" v-on:click='toggleAlternateDeck' href="#">
                            <span v-if='alternate_deck'>&#9746;</span>
                            <span v-else>&#9744;</span>
                            Use Alternate Deck
                        </button>
                        <button class="dropdown-item" v-on:click='toggleMute'>
                            <span v-if='mute'>&#9746;</span>
                            <span v-else>&#9744;</span>
                            Mute
                        </button>
                    </span>
                </span>
            </div>
        </div>
    </div>

    <div id='footer' class='row'>
        <div id='left_footer' class='col'>
            <span>{{servertime}}</span>
            <span>&nbsp;({{server_messages_processed}})</span>
        </div>
        <div id='center_footer' class='col-6 copyright'>&nbsp;</div>
        <div id='right_footer' class='col'>
            <div id='background_color_picker'>
                <div id='background_color_picker_button' style='background-color: green'></div>
            </div>
        </div>
    </div>
    <div id='player'></div>

    <div id='approval_alert' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-6 col-sm-6 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Trick Complete</h5>
                    <button type="button" class="close" v-on:click='approve' data-dismiss="modal">&times;</button>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <p>{{approval_alert_text}}</p>
                        <!--<p class="text-secondary"><small>If you don't save, your changes will be lost.</small></p>-->
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <!--<button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>-->
                        <button type="button" class="btn btn-success" 
                            style='float: right;'
                            v-on:click='approve'>OK
                            </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='claim_alert' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-10 col-sm-10 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Claim by {{claim.name}}</h5>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <p>
                            {{claim.name}} sitting {{claim.seat}} 
                            claims {{claim.tricks_claimed}} tricks 
                            and concedes {{claim.tricks_conceded}}.
                        </p>
                        <p>{{claim.name}}'s Explanation: {{claim.explanation}}</p>
                        <p>Click Accept or Dispute to continue.</p>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='acceptClaim'>Accept
                        </button>
                        <button type='button' class='btn btn-danger' v-on:click='disputeClaim'>Dispute</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='confirm_bid' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-10 col-sm-10 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Confirm your bid of {{current_bid}}</h5>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <p>Click Bid or Cancel.</p>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='bid'>Bid {{current_bid}}
                        </button>
                        <button type='button' class='btn btn-danger' 
                            style='float: right;'
                            v-on:click='cancelBid'>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='confirm_play' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-10 col-sm-10 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Confirm your play of {{proposed_play}}</h5>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <p>Click Play or Cancel.</p>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='playCard(proposed_play_index)'>Play {{proposed_play}}
                        </button>
                        <button type='button' class='btn btn-danger' 
                            style='float: right;'
                            v-on:click='cancelPlayCard'>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='confirm_dummy_play' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-10 col-sm-10 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Confirm your play from dummy of {{proposed_play}}</h5>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <p>Click Play or Cancel.</p>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='playDummyCard(proposed_play_index)'>Play {{proposed_play}}
                        </button>
                        <button type='button' class='btn btn-danger' 
                            style='float: right;'
                            v-on:click='cancelPlayDummyCard'>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='confirm_claim' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-10 col-sm-10 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Confirm your claim</h5>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <div class='row'>
                            Enter number of tricks you claim:
                        </div>
                        <div class='row'>
                            <input id='tricks_claimed_input' v-model='tricks_claimed_input' 
                                v-on:keyup.enter='focusClaimExplanation'
                                placeholder='tricks claimed' autofocus>
                        </div>
                        <div class='row'>&nbsp;</div>
                        <div class='row'>Explain proposed line of play:</div>
                        <div class='row'>
                            <input id='claim_explanation_input' v-model='claim_explanation_input' v-on:keyup.enter='initiateClaim' placeholder='explanation of claim'>
                        </div>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='initiateClaim'>OK
                        </button>
                        <button type='button' class='btn btn-danger' 
                            style='float: right;'
                            v-on:click='cancelClaim'>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='confirm_alert' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-10 col-sm-10 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Alert bid</h5>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <div class='row'>
                            Enter explanation of alert:
                        </div>
                        <div class='row'>
                            <input id='alert_bid_input' v-model='alert_bid' v-on:keyup.enter='okAlert' placeholder='explanation of alert' autofocus>
                            <div class="dropdown">
                                <button type='button' class="btn btn-sm btn-sm-success dropdown-toggle" id="announceMenuToggle" data-toggle="dropdown">Presets...</button>
                                <span class="dropdown-menu">
                                    <button v-for='preset in alert_presets' type='button' 
                                        class="dropdown-item" v-on:click='alert_bid=preset'>
                                        {{preset}}
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='okAlert'>OK
                        </button>
                        <button type='button' class='btn btn-danger' 
                            style='float: right;'
                            v-on:click='cancelAlert'>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id='confirm_announce' class='row modal' tabindex='-1' data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-10 col-sm-10 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>Announce bid</h5>
                </div>
                <div class="row modal-body">
                    <div class='col'>
                        <div class='row'>
                            Enter explanation of announce:
                        </div>
                        <div class='row'>
                            <input v-model='announce_bid' v-on:keyup.enter='okAnnounce' placeholder='explanation of announce' autofocus>
                            <div class="dropdown">
                                <button type='button' class="btn btn-sm btn-sm-success dropdown-toggle" id="announceMenuToggle" data-toggle="dropdown">Presets...</button>
                                <span class="dropdown-menu">
                                    <button v-for='preset in announce_presets' type='button' 
                                        class="dropdown-item" v-on:click='announce_bid=preset'>
                                        {{preset}}
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='okAnnounce'>OK
                        </button>
                        <button type='button' class='btn btn-danger' 
                            style='float: right;'
                            v-on:click='cancelAnnounce'>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id='chat_container' class='row modal' tabindex=-1 data-backdrop='static'>
        <div class='modal-dialog'>
            <div class='col-12 col-sm-12 modal-content'>
                <div class='row modal-header'>
                    <h5 class='modal-title'>
                        <span>{{chat_config.chat_title}}</span>
                        <span v-for='room in chat_config.to_rooms'> &bull; {{room}}</span>
                        <span v-for='player in chat_config.to_players'> &bull; {{player}}</span>
                    </h5>
                    <button type="button" class="close" v-on:click='hideChat' data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class='row'>
                        <div id='chat' class='col col-sm chat'>
                            <p style='white-space: pre-line;'>{{chat_text}}</p>
                        </div>
                    </div>
                    <div class='row'>
                        <div id='chat_input' class='col col-sm chat_input'>
                            <input id='chat_input_elt' v-model='chat_input' v-on:keyup.enter='sendChat' 
                                placeholder='enter chat text' autofocus>
                        </div>
                    </div>
                </div>
                <div class="row modal-footer">
                    <div class='col'>
                        <button type='button' class='btn btn-success' 
                            style='float: right;'
                            v-on:click='sendChat'>Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<!-- Javascript logic -->
<script type='text/javascript'>

    // we need table_id before vm is up to send iam,
    // so this duplicates vm.table_id for good purpose
    const table_id = '%% table.table_id %%';
    const table_channel = '%% table.table_channel %%';
    var autoplay = false;

    const cardNames = [
        "AS", "KS", "QS", "JS", "10S", "9S", "8S" , "7S" , "6S" , "5S" , "4S" , "3S" , "2S",
        "AH", "KH", "QH", "JH", "10H", "9H", "8H" , "7H" , "6H" , "5H" , "4H" , "3H" , "2H",
        "AD", "KD", "QD", "JD", "10D", "9D", "8D" , "7D" , "6D" , "5D" , "4D" , "3D" , "2D",
        "AC", "KC", "QC", "JC", "10C", "9C", "8C" , "7C" , "6C" , "5C" , "4C" , "3C" , "2C"
    ];

    // seat arrangement indexed by vm.seat -> trbl
    const seat_map = {
        'N': {'S':'top', 'W':'right', 'N':'bottom', 'E':'left'},
        'E': {'W':'top', 'N':'right', 'E':'bottom', 'S':'left'},
        'S': {'N':'top', 'E':'right', 'S':'bottom', 'W':'left'},
        'W': {'E':'top', 'S':'right', 'W':'bottom', 'N':'left'}
    };

    const opponents = {
        'N': 'EW',
        'E': 'NS',
        'S': 'EW',
        'W': 'NS'
    };

    const played_card_z_index = {
        'top':      {'top_card': 100, 'right_card': 200, 'bottom_card': 300, 'left_card': 400},
        'right':    {'top_card': 400, 'right_card': 100, 'bottom_card': 200, 'left_card': 300},
        'bottom':   {'top_card': 300, 'right_card': 400, 'bottom_card': 100, 'left_card': 200},
        'left':     {'top_card': 200, 'right_card': 300, 'bottom_card': 400, 'left_card': 100},
    }

    const dummy_from_declarer = {'N':'S', 'E':'W', 'S':'N', 'W':'E'};

    // prevent leaving the table accidentally
    window.onbeforeunload = function() {
        vm.saveState();
        return "Do you really want to leave the table?"
    }

    // enable all bootstrap tooltips
    enable_tooltips = function() {
        $('[data-toggle="tooltip"]').tooltip()
    }

    // copy an object
    copyObject = function(obj) {
        return JSON.parse(JSON.stringify(obj));
    }

    // initialize jquery-level
    $(document).ready(function() {

        // activate tooltips
        enable_tooltips();

        // enable drag on modal dialogs
        $('.modal').each(function(idx, elt) {
            $(elt).draggable({handle: ".modal-header"})
        });
        $('.modal').on('shown.bs.modal', function() {
            $(this).find('[autofocus]').focus();
        });

        // initialize color picker
        $('#background_color_picker').ColorPicker({
            color: 'green',
            onShow: function (colpkr) {
                $(colpkr).show();
                return false;
            },
            onHide: function (colpkr) {
                $(colpkr).hide();
                return false;
            },
            onChange: function (hsb, hex, rgb) {
                $('#background_color_picker div').css('backgroundColor', '#' + hex);
                vm.setBackgroundColor(hsb, hex, rgb);
                vm.saveSettings();
/*
                $('body').css('backgroundColor', '#' + hex);
                if (hsb.b > 90) {
                    $('div').css('color', 'black');
                }
                else {
                    $('div').css('color', 'white');
                }
                vm.saveSettings();
*/
            }
        });
    });

    var vm;

    // Socket.io interface
    var Pushit = {
        init: function() {
            console.log('Initializing socket.io');
            this.socket = io({transports: ['websocket']});
            this.socket.on('connect', function() {
                //vm.status = 'logging in';
                console.log('Socket.io connected');
                Pushit.socket.emit('ping', {data: new Date().getTime()});
            });

            this.socket.on('disconnect', function() {
                console.log('Socket.io disconnected; recoinnecting...');
                Pushit.socket.connect();
            });

            // on reconnection, reset the transports option, as the Websocket
            // connection may have failed (caused by proxy, firewall, browser, ...)
            this.socket.on('reconnect_attempt', () => {
                console.log('socket.io: reconnect_attempt... falling back to polling after websocket failure');
                Pushit.socket.io.opts.transports = ['polling', 'websocket'];
            });
        },
        on: function(message, handler) {
            console.log('Pushit.on', message);
            this.socket.on(message, handler);
        },
        send: function(channel, data) {
            if (channel == 'gameplay') {
                data.table_id = table_id;   // add originating table_id to gameplay data
            }
            console.log('Pushit.send:', channel, data);
            this.socket.emit(channel, data);
        }
    };

    // The Vue structure
    vm = new Vue({
        el: '#app',
        data: {
            status: 'connecting...',
            across_table: {'N':'S', 'E':'W', 'S':'N', 'W':'E'},
            seat: '',
            name_input: '',
            name: '%% session.username %%',
            is_logged_in: '%% table.is_logged_in %%',
            myhand: [],
            dummyhand:[],
            left_dummyhand: [[],[],[],[]],
            right_dummyhand: [[],[],[],[]],
            players: [],
            player_names: {top: '', right:'', bottom:'', left:''},
            show_dummy: '',
            table_number: '%% table.table_number %%',
            table_id: '%% table.table_id %%',
            servertime: '...connecting...',
            show_chat: false,
            chat_text: '',
            chat_input: '',
            chat_config: {},
            missing: 'NESW',
            hand: {},
            show_cards_played: false,
            showing_last_card: false,
            cards_played: {},
            cards_played_list: [],  // for bot
            cards_remaining: {N:[], E:[], S:[], W:[]},
            tricks_played: [],
            show_bidding: false,
            bid_buttons: [],
            bids: {top:[], right:[], bottom:[], left:[]},
            bid_list: [],
            bidding: false,
            bid_table: [],
            to_play: false,
            dummy_to_play: false,
            approval_alert_text: '',
            round_complete: false,
            show_grid: true,
            show_claim: false,
            show_claim_buttons: false,
            //claim:  {'cmd': 'iclaim', 'name': 'Gandalf', 'seat': 'N', 'player': 'N', 'tricks_claimed': 10, 'tricks_conceded': 2}
            claim: {},
            claimhand: [],
            left_claimhand: [],
            right_claimhand: [],
            tricks_claimed_input: '',
            claim_explanation_input: '',
            show_scores: false,
            table_results: [],

            declarerhand: [],
            show_declarer: false,
            alert_bid: '',
            alert_presets: [],
            announce_bid: '',
            announce_presets: ['15-17', 'Transfer', 'Could be short'],
            current_player: '',
            current_bid: '',
            current_bid_index: 0,
            proposed_play: '',
            proposed_play_index: 0,
            autoplay: false,
            autoplay_delay: 63,
            mylastcard: {},
            two_click_bids: true,
            two_click_plays: false,
            show_debug_menu: false,
            show_claimhand: false,
            saved_at: 0,
            open_modals: [],
            server_messages_processed: 0,
            mute: false,
            background: {"hsb":{"h":180,"s":40,"b":30},"hex":"2f4f4f","rgb":{"r":47,"g":79,"b":79}},
            late_play: false,
            alternate_deck: false
        },
        created: function() {
            console.log('Vue up...');
            Pushit.init();

            // clean up the incoming template data
            if (this.is_logged_in == 'False') this.is_logged_in = false;
            else this.is_logged_in = true;
        
            // for testing: prefer name from the url over template
            var url = new URL(document.location.href);
            var name = url.searchParams.get('name');
            if (name != null) {
                this.name = name;
                this.is_logged_in = false;
            }
            if (this.name) {
                Pushit.send(table_channel, {
                    cmd: 'iam',
                    name: this.name
                });
                window.document.title = 'id:' + table_id + ' ' + this.name;
            }

            autoplay = url.searchParams.get('autoplay');
            if (autoplay != null) this.autoplay = true;

            this.restoreState();
            this.loadSettings();

            // handle game lifecycle messages
            Pushit.on(this.table_id, function(msg) {
    
                console.log(vm.table_id, msg.cmd, msg);

                if (('players' in msg) && ('Paul' in msg.players) && ('password' in msg.players.Paul)) {
                    console.log('PASSWORD IN PLAYERS');
                }

                // post message text as {{status}} if it's present
                if ('text' in msg) {
                    vm.status = msg.text;
                }
    
                switch (msg.cmd) {

                    case 'addplayer':
                    case 'players':
                        vm.players = msg.players;
                        for (player_seat in vm.players) {
                            // capture seat assignment for this name
                            if (vm.players[player_seat].name.toLowerCase() == vm.name.toLowerCase()) {
                                vm.seat = player_seat;
                            }

                            // populate player_names once we know our seat
                            if (vm.seat) {
                                const trbl = seat_map[vm.seat][player_seat];
                                vm.player_names[trbl] = {
                                    seat: player_seat,
                                    name: vm.players[player_seat].name,
                                    bot: vm.players[player_seat].bot
                                }
                            }
                        }
                        break;

                    case 'startbidding':
                        vm.playSound('shuffle');
                        vm.reset_to_start();
                        vm.initBids();
                        vm.initBidButtons();
                        vm.bidding = true;
                        vm.hand = msg.hand;
                        vm.cards_remaining = copyObject(msg.hand.cards);
                        vm.myhand = vm.sort_hand(vm.hand.cards[vm.seat]);
                        if (msg.tobid == vm.seat) {
                            vm.show_bidding = 1;
                            if (vm.autoplay) window.setTimeout(vm.autoBid, vm.autoplay_delay);
                        }
                        vm.current_player = msg.tobid;
                        console.log('resetting server_messages_processed:', vm.server_messages_processed);
                        vm.server_messages_processed = 0;   // reset message count
                        vm.saveState();                     // and force to cache
                        break;
    
                    // {cmd:.., bids:[], tobid:'NESW', text: 'ned to bid'}
                    case 'gotbid':
                        vm.playSound('carddrop');
                        var bid_location = seat_map[vm.seat][msg.bid.player];
                        vm.bids[bid_location].push(msg);
                        vm.bid_list.push(msg);

                        // Update bid table
                        if ((vm.bid_table.length == 0) || (msg.bid.player == 'W')) {
                            vm.bid_table.push({'W':'', 'N':'', 'E': '', 'S':''});
                        }
                        vm.bid_table[vm.bid_table.length-1][msg.bid.player] = msg;

                        // blank the alert/announce data from this player's partner
                        if (msg.bid.player == vm.across_table[vm.seat]) {
                            delete vm.bid_table[vm.bid_table.length-1][msg.bid.player].bid.alert;
                            delete vm.bid_table[vm.bid_table.length-1][msg.bid.player].bid.announce;
                        }

                        window.setTimeout(enable_tooltips, 50);
                        break;
    
                    case 'tobid':
                        if (msg.tobid == vm.seat) {
                            vm.show_bidding = 1;
                            if (vm.autoplay) window.setTimeout(vm.autoBid, vm.autoplay_delay);
                        }
                        vm.current_player = msg.tobid;
                        vm.hand.contract = msg.contract;
                        vm.invalidateBidButtons();
                        break;
    
                    case 'endbidding':
                        vm.hand = msg.hand;
                        vm.myhand = vm.sort_hand(vm.hand.cards[vm.seat]);
                        if ('dummycards' in vm.hand) {
                            // vm.dummyhand = vm.hand.dummycards.sort((a,b)=>a-b);
                            vm.dummyhand = vm.sort_dummy(vm.hand.dummycards, vm.hand.contract);
                            vm.left_dummyhand = vm.sort_dummy_side(vm.dummyhand, vm.hand.contract);
                            vm.right_dummyhand = vm.sort_dummy_side(vm.dummyhand, vm.hand.contract, true);  // 'true' to reverse the sort
                        }
                        if (vm.seat == vm.hand.dummyseat) vm.declarerhand = vm.sort_hand(vm.hand.cards[vm.hand.declarer]);
                        //vm.bidding = false;
                        break;
    
                    case 'starttrick':
                        vm.current_player = msg.toplay;
                        vm.status = '';
                        // a player may play her own cards
                        if ((msg.toplay == vm.seat) && (vm.seat != vm.hand.dummyhand)) {
                            vm.to_play = true;
                            if (vm.autoplay) window.setTimeout(vm.autoPlayCard, vm.autoplay_delay);
                        }
                        else if ((msg.toplay == vm.hand.dummyhand) && (vm.seat == vm.hand.declarer)) {
                            vm.dummy_to_play = true;
                            if (vm.autoplay) window.setTimeout(vm.autoPlayDummyCard, vm.autoplay_delay);
                        }
                        vm.show_cards_played = true;
                        break;
    
                    case 'cardplayed': // Whenever any one of 4 dirs plays card
                        if (vm.cards_played_list.length == 0) {
                            vm.cards_played = {}; // Erase any 'mylastcard' cards a player clicked for review
                            vm.bidding = false;
                        }
                        vm.playSound('carddrop');

                        // show the dummy and hide the bidding; this handles special case of first card in trick
                        if (!vm.show_dummy) {
                            // set show_dummy to left, top, or right
                            const dummy_seat = dummy_from_declarer[vm.hand.declarer]
                            vm.show_dummy = seat_map[vm.seat][dummy_seat];
                            console.log('show_dummy:', vm.show_dummy);
                            if (vm.seat == vm.hand.dummyseat) vm.show_declarer = true;
                        }
                        vm.initBids();

                        // save the played card in vm.cards_played indexed by top/right/bottom/left
                        // vm.cards_played -> {'top':{card}, 'right':{card}, 'bottom':{card}, 'left':{card}}
                        var trbl = seat_map[vm.seat][msg.player]
                        console.log('TRBL:', trbl)

                        // stack the cards correctly on the center play area
                        if (vm.cards_played_list.length % 4 == 0) {
                            vm.initPlayedCardLayering(trbl);
                        }

                        vm.cards_played[trbl] = msg;
                        vm.cards_played_list.push(msg);

                        // remove the played card from "remaining cards" array
                        vm.cards_remaining[msg.player] = vm.cards_remaining[msg.player].filter(function(value, index) { return value != msg.cardindex; });

                        // remove played card from player's hand
                        if (msg.player == vm.seat) {
                            vm.myhand = vm.myhand.filter(function(value, index) {
                                return value != msg['cardindex'];
                            });
                        }
                        if (msg.player == vm.hand.declarer) { // If declarer played from her hand, need to remove from dummy's view.
                            vm.declarerhand = vm.declarerhand.filter(function (value, index) {
                                return value != msg['cardindex'];
                            });
                        }
                        if (msg.player == vm.hand.dummyhand) {
                            vm.dummyhand = vm.dummyhand.filter(function (value, index) {
                                return value != msg['cardindex'];
                            });
                            for (var i = 0; i < 4; i++) {
                                vm.left_dummyhand[i] = vm.left_dummyhand[i].filter(function (value, index) {
                                    return value != msg['cardindex'];
                                });
                                vm.right_dummyhand[i] = vm.right_dummyhand[i].filter(function (value, index) {
                                    return value != msg['cardindex'];
                                });
                            }
                        }
                        break;
    
                    case 'nextplay':
                        vm.current_player = msg.toplay;
                        if ((msg.toplay == vm.seat) && (vm.seat != vm.hand.dummyhand)) {
                            vm.to_play = true;
                            if (vm.autoplay) window.setTimeout(vm.autoPlayCard, vm.autoplay_delay);
                        }
                        else if ((msg.toplay == vm.hand.dummyhand) && (vm.seat == vm.hand.declarer)) {
                            vm.dummy_to_play = true;
                            if (vm.autoplay) window.setTimeout(vm.autoPlayDummyCard, vm.autoplay_delay);
                        }
                        break;
    
                    case 'claim':
                        // show the claim approval UI to everyone but claimer
                        if (msg.seat != vm.seat) {

                            if (vm.autoplay) {
                                vm.show_claim_buttons = true;   // kludge on the kludge in acceptClaim
                                vm.acceptClaim();
                                break;
                            }

                            vm.claim = msg;
                            vm.show_claim = true;
                            vm.show_claim_buttons = true;
                            window.setTimeout(function() {
                                $('#claim_alert').modal('show');
                            }, 100);
                            // Create hands we can show.
                            vm.show_claimhand = seat_map[vm.seat][msg.seat];
                            var claimercards = vm.cards_remaining[msg.seat];
                            claimercards = vm.sort_hand(claimercards);
                            if ("top" == vm.show_claimhand) {
                                vm.claimhand = claimercards;
                            }
                            else if ("right" == vm.show_claimhand) {
                                vm.right_claimhand = vm.sort_dummy_side(claimercards, vm.hand.contract, true);  // 'true' to reverse card order for rhs
                            }
                            else if ("left" == vm.show_claimhand) {
                                vm.left_claimhand = vm.sort_dummy_side(claimercards, vm.hand.contract);
                            }
                            vm.claim = msg; // DEBUG

                            // set a timer to take down the dummy's claim window in 5 seconds
                            if (vm.seat == vm.hand.dummyseat) {
                                console.log('setting dummy takedown timer');
                                window.setTimeout(vm.acceptClaim, 5000);
                            }
                        }
                        break;

                    case 'endclaim':
                        vm.show_claim = false;
                        vm.show_claim_buttons = false;
                        window.setTimeout(function() { 
                            $('#claim_alert').modal('hide');
                        }, 50);
                        // exit trick approval mode
                        if (msg.resolution == 'accepted') {
                            vm.approval_alert_text = '';
                            vm.status = 'Claim accepted';
                        }
                        break;

                    case 'endtrick':
                        vm.tricks_played.push(msg);
                        // everyone but the dummy must approve
                        if (vm.seat != dummy_from_declarer[vm.hand.declarer]) {
                            if (vm.autoplay) {
                                window.setTimeout(vm.approve, vm.autoplay_delay);
                            }
                            else {
                                vm.approval_alert_text = msg.winner + ' wins the trick.  Click OK to continue.';
                                window.setTimeout(function() {
                                    let a = $('#approval_alert');
                                    a.modal('show');
                                    a.css('top', '50vh');
                                    a.css('left', '-15vw');
                                }, 50);
                                vm.status = vm.approval_alert_text;
                            }
                        }
                        vm.hand.NStricks_won = msg.NStricks_won;
                        vm.hand.EWtricks_won = msg.EWtricks_won;
                        vm.to_play = false;
                        vm.mylastcard = vm.cards_played.bottom;
                        break;
    
                    case 'endapprovals': // Trick approvals
                        vm.show_cards_played = false;
                        vm.cards_played = {};
                        vm.cards_played_list = [];
                        vm.status = '';     // take down 'waiting for approvals'
                        break;
    
                    // { cmd: endhand, text:msg, winner: seat, hand_score: int, hand_scores: [scores]}
                    case 'endhand':
                        vm.hand.score = msg.hand_score;
                        vm.table_results = msg.hand_scores;
                        vm.show_scores = true;
                        vm.hand.NStricks_won = msg.NStricks_won;
                        vm.hand.EWtricks_won = msg.EWtricks_won;
                        vm.to_play = false;
                        vm.dummy_to_play = false;
                        if (vm.autoplay) window.setTimeout(vm.approveHand, vm.autoplay_delay);
                        // client side timeout disabled; handled on server
                        // else window.setTimeout(vm.approveHand, 10000);
                        break;

                    case 'approvehand':
                        vm.show_scores = false;
                        vm.reset_to_start();
                        break;
    
                    case 'lateplay':
                        vm.late_play = true;
                        break;

                    case 'endround':
                        vm.goToLobby();
                        //vm.round_complete = true;
                        //vm.table_results = msg.table_results;
                        //vm.show_scores = true;
                        break;

                    case 'lobby':
                        vm.goToLobby();
                        break;

                    case 'logout':
                        window.onbeforeunload = function() {};
                        document.location.href = '/logout';
                        break;

                    case 'log':     // {'cmd':'log', 'text':'...'}
                        // nothing to do - text was already logged
                        break;
    
                    case 'chat':
                        console.log('chat:', msg);
                        Sound.play('tweet');
                        if (('to_players' in msg) && (msg['to_players'][0] == 'Director')) vm.showDirectorChat();
                        else vm.showChat();
                        var now = new Date();
                        if (vm.chat_text.length) vm.chat_text += '\n';
                        vm.chat_text += '[' + vm.getChatTimestamp() + '] ' + msg.name + ': ' + msg.chat_text;
                        if (vm.show_chat) {
                            var objDiv = document.getElementById('chat');
                            objDiv.scrollTop = objDiv.scrollHeight;
                        }
                        if ('to_rooms' in msg) vm.chat_config.to_rooms = msg.to_rooms;
                        if ('to_players' in msg) vm.chat_config.to_players = msg.to_players;
                        break;
                    
                    case 'noconnect':
                        // redirect to "Cannot connect..." page
                        document.location.href = '/static/noconnect.html';
                        break;

                    default:
                        console.log('unknown command:', msg)
                }

                // save state after each incoming message has been processed
                ++vm.server_messages_processed;
                vm.saveState();
            });
    
            //Pushit.on('ping', function(data) {
            //    console.log('got ping', data);
            //    if (data) {
            //        data.pongtime = new Date().getTime();
            //        Pushit.send('pong', data);
            //    }
            //});
            
            Pushit.on('time', function(msg) {
                vm.servertime = new Date().toLocaleString();
            });
        },
        methods: {
            setName: function(name) {
                console.log('setName:', name);
                this.name = this.name_input;
            },
            getImgUrl: function(card) {
                if (this.alternate_deck) {
                    return('/static/svg-cards/' + cardNames[card] + '.svg');
                }
                else {
                    return('/static/cards/' + cardNames[card] + '.png');
                }
            },
            getImgUrlFromCardPlayed: function(cardname) {
                if (this.alternate_deck) {
                    return('/static/svg-cards/' + cardname.split(':')[1] + '.svg');
                }
                else {
                    return('/static/cards/' + cardname.split(':')[1] + '.png');
                }
            },
            getCardBackImg: function() {
                if (this.alternate_deck) {
                    return '/static/card-backs/back-red.png';
                }
                else {
                    return '/static/card-backs/back-teal.png';
                }
            },
            logOut: function() {
                if (confirm('Log out and leave the game?')) {
                    document.location.href = '/logout';
                }
            },
            initBids: function() {
                vm.bids = {top:[], right:[], bottom:[], left:[]};
                vm.bid_list = [];
                vm.bid_table = [];
            },
            initBidButtons: function() {
                // initialize bidding buttons
                vm.bid_buttons = [];
                for (var rank = 1; rank<=7; rank++) {
                    for (var suit=0; suit<=4; suit++) {
                        this.bid_buttons.push({
                            label: rank.toString() + ' ' + ['clubs', 'diamonds', 'hearts', 'spades', 'no trump'][suit],
                            html_label: rank.toString() + ['&clubs;', '&diams;', '&hearts;', '&spades;', 'NT'][suit],
                            color: ['black', 'red', 'red', 'black', 'black'][suit],
                            background: 'white',
                            bid: rank.toString() + 'CDHSN'[suit],
                            disabled: false
                        });
                    }
                }
                this.bid_buttons.push({
                    label: 'X',
                    html_label: 'X',
                    color: 'white',
                    background: 'darkred',
                    bid: 'X',
                    disabled: false
                });
                this.bid_buttons.push({
                    label: 'XX',
                    html_label: 'XX',
                    color: 'white',
                    background: 'darkblue',
                    bid: 'XX',
                    disabled: false
                });
                this.bid_buttons.push({
                    label: 'PASS',
                    html_label: 'PASS',
                    color: 'white',
                    background: 'green',
                    bid: 'PASS',
                    disabled: false
                });
            },
            invalidateBidButtons: function() {
                if (!vm.hand.contract) return;
                const contract_rank = parseInt(vm.hand.contract[0]);
                const contract_suit = vm.hand.contract.substr(1);
                const contract_suit_number = {'C':0, 'D':1, 'H':2, 'S':3, 'N':4}[contract_suit];
                const last_valid_index = (contract_rank - 1) * 5 + contract_suit_number;
                console.log('invalidateBidButtons:', contract_rank, contract_suit, last_valid_index);
                // shut 'em down.  shut 'em all down.
                for (var b=0; b <= last_valid_index; b++) {
                    vm.bid_buttons[b].disabled = true;
                }
            },
            confirmBid: function(button_index) {
                if (this.bid_buttons[button_index].disabled) return;
                this.current_bid_index = button_index;
                this.current_bid = this.bid_buttons[button_index].bid;
                if (this.autoplay || !this.two_click_bids) {
                    this.bid();
                    return;
                }
                window.setTimeout(function() {
                    $('#confirm_bid').modal('show');
                }, 100);
            },
            cancelBid: function() {
                $('#confirm_bid').modal('hide');
            },
            bid: function() {

                // ignore disabled buttons
                if (this.bid_buttons[vm.current_bid_index].disabled) return;

                $('#confirm_bid').modal('hide');
                this.show_bidding = false;

                // prepare an ibid message for the server
                var theBid = this.bid_buttons[vm.current_bid_index].bid;
                var bid_msg = {
                    cmd: 'ibid', 
                    player: this.seat, 
                    bid: theBid,
                    bid_data: this.bid_buttons[vm.current_bid_index]
                };

                // handle alert
                if (this.alert_bid) {
                    if (this.alert_presets.indexOf(this.alert_bid) < 0) {
                        this.alert_presets.push(this.alert_bid);
                        this.saveSettings();
                    }
                    bid_msg.alert = this.alert_bid;
                    this.alert_bid = '';
                }
                // handle announce
                else if (this.announce_bid) {

                    // disallow Pass/X/XX on announce
                    if ((bid_msg.bid_data.bid == 'X') || (bid_msg.bid_data.bid == 'XX') || (bid_msg.bid_data.bid == 'PASS')) {
                        this.status = 'Cannot Announce on X, XX, or PASS';
                        this.announce_bid = '';
                        this.show_bidding = true;
                        return;
                    }
                    bid_msg.announce = this.announce_bid;
                    if (this.announce_presets.indexOf(this.announce_bid) < 0) {
                        this.announce_presets.push(this.announce_bid);
                        this.saveSettings();
                    }
                    this.announce_bid = '';
                }
                Pushit.send(table_channel, bid_msg);
            },
            void_in_suit: function (cards, suit_base) {
                if (!cards) return true;
                var are_void = true;
                var n = cards.length;
                for (var i = 0; i < n; i++) {
                    if ((cards[i] >= suit_base) && (cards[i] < suit_base + 13)) { // Found one?
                        are_void = false;
                        break;
                    }
                }
                return are_void;
            },
            bump_suit: function (cards, suit_base, amount) {
                var n = cards.length;
                for (var i = 0; i < n; i++) {
                    if ((cards[i] >= suit_base) && (cards[i] < suit_base + 13)) cards[i] += amount; // Bump clubs between red suits.
                }
            },
            sort_hand: function (cards) {
                // First, if void in hearts, we don't do anything.
                var no_hearts = vm.void_in_suit(cards, 13);
                if (false == no_hearts) {
                    // Swap diamonds and clubs by adding 64 to all diamonds.
                    vm.bump_suit(cards, 26, 64); // Bump the diamonds.
                    // If void in clubs, add 64 to all spades in order to put between hearts and diamonds.
                    var no_clubs = vm.void_in_suit(cards, 39);
                    if (no_clubs) vm.bump_suit(cards, 0, 64); // Bump the diamonds.

                }
                cards.sort((a, b) => a - b);
                var n = cards.length;
                for (var i = 0; i < n; i++) { // Remove adders that ordered suits.
                    cards[i] %= 64;
                }
                return cards;
            },
            sort_dummy: function(cards, contract) { // Function to sort the dummies card when displayed on top.
                // Rules are: trump suit first, then alternate colors.
                // Make trump suit first by adding 256 to all other cards.
                var trump_suit = 4 // Default to no trump.
                if ('C' == contract[1]) trump_suit = 0;
                else if ('D' == contract[1]) trump_suit = 1;
                else if ('H' == contract[1]) trump_suit = 2;
                else if ('S' == contract[1]) trump_suit = 3;
                if (trump_suit >= 3) return vm.sort_hand(cards); // Normal sorting for spades and NT
                var n = cards.length;
                for (var i = 0; i < n; i++) cards[i] += 256;
                vm.bump_suit(cards, 256 + (3 - trump_suit) * 13, -256); // Unbump trump.
                if ((trump_suit == 1) || (trump_suit == 2)) { // Red suit?
                    // If we have spades, we are all done, otherwise bump clubs in between the red suits
                    if (vm.void_in_suit(cards, 256)) vm.bump_suit(cards, 256+39, -128);
                }
                else { // Sorting for clubs
                    var n = cards.length;
                    if (vm.void_in_suit(cards, 256+13)) vm.bump_suit(cards, 256+26, -128); // If void in hearts, insert diamonds between C and S.
                    else vm.bump_suit(cards, 256+13, -128); // Put hearts between clubs and spades.
                }
                cards.sort((a, b) => a - b);
                for (var i = 0; i < n; i++) {
                    cards[i] %= 64;
                }
                return cards;
            },
            sort_dummy_side: function(cards, contract, reverse) { // Function to sort the dummies card when displayed left or right.
                // Rules are: trump suit on top, then alternate colors.
                // Cards should be sorted this way, just need to break into four groups.
                // 'reverse' argument is used to reverse order for the right display panel
                var grid_dummyhand = [[], [], [], []];
                var suit_index = 0;
                var j = 0;
                var n = cards.length;
                var suit_in_progress = Math.floor(cards[0] / 13);
                for (var i = 0; i < n; i++) {
                    if (Math.floor(cards[i] / 13) != suit_in_progress) { // Changed suit?
                        suit_in_progress = Math.floor(cards[i] / 13);
                        suit_index++;
                        j = 0;
                    }
                    grid_dummyhand[suit_index][j++] = cards[i];
                }

                // reverse the card order within suit for the right hand dummy and claim display
                if (reverse) {
                    console.log('reversing dummy sort')
                    for (var i=0; i<4; i++) grid_dummyhand[i].reverse();
                }

                return grid_dummyhand;
            },

            confirmPlayCard: function(index) {
                if (this.autoplay || !this.two_click_plays) {
                    this.playCard(index);
                    return;
                }
                this.proposed_play_index = index;
                this.proposed_play = cardNames[this.myhand[index]];
                window.setTimeout(function() {
                    $('#confirm_play').modal('show');
                }, 100);
            },
            cancelPlayCard: function(index) {
                $('#confirm_play').modal('hide');
            },
            playCard: function(index) {
                console.log('playcard:', index);
                $('#confirm_play').modal('hide');
    
                // ignore clicks in the dummy player's main hand
                if (vm.seat == vm.hand['dummyhand']) return;
    
                // ignore clicks if it's not our turn to play
                if (!vm.to_play) return;
    
                Pushit.send(table_channel, {
                    cmd: 'iplay', 
                    player: vm.seat, 
                    card: vm.myhand[index]
                });
                vm.to_play = false;     // prevent a second click from firing
            },

            confirmPlayDummyCard: function(index) {
                if (this.autoplay || !this.two_click_plays) {
                    this.playDummyCard(index);
                    return;
                }
                this.proposed_play_index = index;
                this.proposed_play = cardNames[this.dummyhand[index]];
                window.setTimeout(function() {
                    $('#confirm_dummy_play').modal('show');
                }, 100);
            },
            cancelPlayDummyCard: function(index) {
                $('#confirm_dummy_play').modal('hide');
            },
            playDummyCard: function(index) {
                console.log('playdummycard:', index);
                $('#confirm_dummy_play').modal('hide');
    
                // if you aren't the declarer you can't play for the dummy
                if (vm.seat != vm.hand.declarer) return;
    
                if (!vm.dummy_to_play) return;
    
                Pushit.send(table_channel, {
                    cmd: 'iplay', 
                    for_dummy: vm.hand.dummyhand,
                    player: vm.seat, 
                    card: vm.dummyhand[index]
                });
                vm.dummy_to_play = false;   // prevent a second click from firing
            },
            approve: function () {
                console.log('approve:');
                Pushit.send(table_channel, {
                    cmd: 'iapprove',
                    name: vm.name,
                    seat: vm.seat,
                    player: vm.seat
                });
                vm.approval_alert_text = '';
                window.setTimeout(function() {
                    $('#approval_alert').modal('hide');
                }, 50);
            },
            approveHand: function () {
                if (!vm.show_scores) return;    // don't send twice
                Pushit.send(table_channel, {
                    cmd: 'iapprovehand',
                    name: vm.name,
                    seat: vm.seat
                });
                vm.show_scores = false;
                vm.reset_to_start();
                vm.status = 'Waiting for approvals...';
            },
            confirmClaim: function() {
                vm.tricks_claimed_input = (13 - vm.tricks_played.length).toString();
                vm.claim_explanation_input = '';
                $('#confirm_claim').modal('show');
            },
            cancelClaim: function() {
                $('#confirm_claim').modal('hide');
            },
            focusClaimExplanation: function() {
                $("#claim_explanation_input").focus();
            },
            initiateClaim: function() {
                if (!this.tricks_claimed_input || !this.tricks_claimed_input.match(/\d+/g)) {
                    this.status = 'Please enter number of tricks claimed';
                    return;
                }

                if (!this.claim_explanation_input) {
                    this.status = 'Please enter an explanation of your claim';
                    return;
                }

                var tricks_claimed = parseInt(this.tricks_claimed_input);
                var tricks_remaining = 13 - vm.tricks_played.length;

                if ((tricks_claimed < 0) || (tricks_claimed > tricks_remaining)) {
                    this.status = 'Please enter a number between 0 and ' + tricks_remaining.toString();
                    return;
                }
                this.status = '';

                Pushit.send(table_channel, {
                    cmd: 'claim', 
                    name: vm.name,
                    seat: vm.seat,
                    player: vm.seat,
                    tricks_claimed: tricks_claimed,
                    tricks_conceded: tricks_remaining - tricks_claimed,
                    explanation: vm.claim_explanation_input
                });
                $('#confirm_claim').modal('hide');
            },
            acceptClaim: function() {
                // prevent executing this path twice if the dummy person clicks Accept
                // and then the 5000 ms auto-click timer fires and calls in here again
                if (!vm.show_claim_buttons) return;

                Pushit.send(table_channel, {
                    cmd: 'iacceptclaim', 
                    name: vm.name,
                    seat: vm.seat
                });
                vm.show_claim_buttons = false;
                window.setTimeout(function() {
                    $('#claim_alert').modal('hide');
                }, 50);
                vm.status = 'Waiting for claim resolution...';
            },
            disputeClaim: function() {
                Pushit.send(table_channel, {
                    cmd: 'idisputeclaim', 
                    name: vm.name,
                    seat: vm.seat
                });
                vm.show_claim_buttons = false;
                window.setTimeout(function() {
                    $('#claim_alert').modal('hide');
                }, 50);
                vm.status = '';
            },
            cardsPlayed: function() {
                var count = 0;
                for (var direction in ['top','right','bottom','left']) {
                    if (direction in vm.cards_played) count++;
                }
                return count;
            },
            showChat: function() {
                vm.show_chat = true;
                vm.chat_config = {
                    chat_title: 'Chat',
                    to_rooms: [vm.table_id],
                    to_players: []
                }
                $('#chat_container').modal('show');
            },
            showOpponentsChat: function() {
                vm.show_chat = true;
                vm.chat_config = {
                    chat_title: 'Chat with Opponents',
                    to_rooms: [],
                    to_players: [vm.name, vm.player_names.left.name, vm.player_names.right.name]
                }
                $('#chat_container').modal('show');
            },
            hideChat: function() {
                vm.show_chat = false;
                vm.chat_config = {};
                $('#chat_container').modal('hide');
            },
            getChatTimestamp: function() {
                var now = new Date();
                var hours = (now.getHours() % 12).toString();
                var minutes = now.getMinutes().toString();
                if (minutes.length < 2) minutes = '0' + minutes;
                return hours + ':' + minutes;
            },
            showDirectorChat: function() {
                vm.show_chat = true;
                vm.chat_config = {
                    chat_title: 'Director Chat',
                    to_rooms: [vm.table_id],
                    to_players: ['Director']
                }
                $('#chat_container').modal('show');
            },
            callDirector: function () {
                vm.showDirectorChat();
                vm.chat_input = 'Paging the Director to ' + vm.table_id;
                vm.sendChat();
            },
            sendChat: function(event) {
                if (!vm.chat_input) return;
                var msg = {
                    cmd: 'chat',
                    name: vm.name,
                    seat: vm.seat,
                    chat_text: vm.chat_input
                };
                if ('to_rooms' in vm.chat_config) msg.to_rooms = vm.chat_config.to_rooms;
                if ('to_players' in vm.chat_config) msg.to_players = vm.chat_config.to_players;
                console.log('sendChat:', msg);
                Pushit.send(table_channel, msg);
                vm.chat_input = '';
            },
            showConventionCard: function(event) {
                const opponent1 = opponents[vm.seat][0];
                const opponent2 = opponents[vm.seat][1];
                var id = '';
                if (vm.players[opponent1].convention_card) {
                    id = vm.players[opponent1].convention_card;
                }
                else if (vm.players[opponent2].convention_card) {
                    id = vm.players[opponent2].convention_card;
                }
                if (id.length) {
                    window.open('/get_convention_card/' + id, '_blank');
                }
                else {
                    this.status = 'No convention card available for this pair.';
                }
            },
            toggleTwoClickBids: function () {
                vm.two_click_bids = !vm.two_click_bids;
                vm.saveSettings();
            },
            toggleTwoClickPlays: function () {
                vm.two_click_plays = !vm.two_click_plays;
                vm.saveSettings();
            },
            toggleMute: function() {
                vm.mute = !vm.mute;
                vm.saveSettings();
            },
            toggleAlternateDeck: function() {
                vm.alternate_deck = !vm.alternate_deck;
                vm.saveSettings();
            },
            goToLobby: function() {
                window.onbeforeunload = function() {};
                var url = '/lobby';
                if (!vm.is_logged_in) {
                    url += '?name=' + encodeURIComponent(vm.name);
                    // use 'autoplay', not 'this.autoplay', to pass on state from url, not saved state
                    if (autoplay) url += '&autoplay=1';
                }
                document.location.href = url;
            },
            toggleGrid: function() {
                if (vm.show_grid) $('div').css('border', 'none');
                else $('div').css('border', '1px solid green');
                vm.show_grid = !vm.show_grid;
            },
            restartPlay: function() {
                Pushit.send(table_channel, {
                    cmd: 'abort', 
                    seat: this.seat, 
                    name: this.name
                });
            },
            reset_to_start: function() {
                vm.myhand = [];
                vm.dummyhand = [];
                vm.left_dummyhand = [[],[],[],[]];
                vm.right_dummyhand = [[],[],[],[]];
                vm.show_dummy = '';
                vm.show_chat = false;
                vm.chat_text = '';
                vm.chat_input = '';
                vm.missing = 'NESW';
                vm.hand = {};
                vm.show_cards_played = false;
                vm.cards_played = {};
                vm.cards_played_list = [];
                vm.tricks_played = [];
                vm.show_bidding = false;
                vm.bids = {top:[], right:[], bottom:[], left:[]};
                vm.to_play = false;
                vm.dummy_to_play = false;
                vm.approval_alert_text = '';
                vm.round_complete = false;
                vm.show_grid = true;
                vm.show_claim = false;
                vm.claim = {};
                vm.show_scores = false;
                vm.table_results = [];
                vm.pair_scores = [];
                vm.declarerhand = [];
                vm.show_declarer = false;
                vm.alert_bid = '';
                vm.announce_bid = '';
                vm.claimhand = [];
                vm.left_claimhand = [[], [], [], []];
                vm.right_claimhand = [[], [], [], []]
                vm.show_claimhand = ''; // 'top', 'left', or 'right'
                
            },
            toggleAlert: function() {
                if (vm.alert_bid) {
                    vm.alert_bid = '';
                    $('#confirm_alert').modal('hide');
                }
                else {
                    vm.alert_bid = '';
                    $('#confirm_alert').modal('show');
                    vm.announce_bid = '';
                }
            },
            cancelAlert: function() {
                vm.alert_bid = '';
                $('#confirm_alert').modal('hide');
            },
            okAlert: function() {
                $('#confirm_alert').modal('hide');
            },
            toggleAnnounce: function() {
                if (vm.announce_bid) {
                    vm.announce_bid = '';
                    $('#confirm_announce').modal('hide');
                }
                else {
                    vm.announce_bid = '';
                    $('#confirm_announce').modal('show');
                    vm.alert_bid = '';
                }
            },
            cancelAnnounce: function() {
                vm.announce_bid = '';
                $('#confirm_announce').modal('hide');
            },
            okAnnounce: function() {
                $('#confirm_announce').modal('hide');
            },
            playSound: function(sound) {
                if (vm.mute || vm.autoplay) return;
                Sound.play(sound);
            },
            showLastCard: function (trickindex) {
                if (vm.cards_played_list.length > 0) return;
                if (vm.tricks_played.length != trickindex + 1) return;
                vm.cards_played.bottom = vm.mylastcard;
                vm.show_cards_played = true;
                vm.showing_last_card = true;
            },
            hideLastCard: function() {
                delete vm.cards_played['bottom'];
                vm.showing_last_card = false;
            },
            toggleDebugMenu: function(event) {
                // require a modifier key to show the menu
                if (!this.show_debug_menu) {
                    var modifiers = 0;
                    if (event.ctrlKey) modifiers++;
                    if (event.altKey) modifiers++;
                    if (event.metaKey) modifiers++;
                    if (event.shiftKey) modifiers++;
                    if (modifiers < 1) return;
                }
                this.show_debug_menu = !this.show_debug_menu;
            },

            // robot play
            getSuit: function(cardindex) {
                return Math.floor(cardindex / 13);
            },
            autoBid: function() {
                if (!vm.autoplay) return;
                if (!vm.show_bidding) return;
                vm.alert_bid = '';
                vm.announce_bid = '';
                // if there are no bids, bid 1D
                if (vm.bid_list.length == 0) vm.confirmBid(Math.floor(Math.random() * 5));
                // otherwise, PASS
                else vm.confirmBid(37);
            },
            autoPlayCard: function() {
                if (!vm.autoplay) return;
                // follow suit if a card was led
                if (vm.cards_played_list.length > 0) {
                    const lead_suit = vm.getSuit(vm.cards_played_list[0].cardindex);
                    // find a card with matching suit and play it
                    for (var i=0; i < vm.myhand.length; i++) {
                        if (vm.getSuit(vm.myhand[i]) == lead_suit) {
                            vm.playCard(i);
                            return;
                        }
                    }
                }
                // otherwise play a random card
                if (vm.myhand.length > 0) {
                    //vm.playCard(0);
                    vm.playCard(Math.floor(Math.random() * vm.myhand.length));
                }
            },
            autoPlayDummyCard: function() {
                if (!vm.autoplay) return;
                // follow suit if a card was led
                if (vm.cards_played_list.length > 0) {
                    const lead_suit = vm.getSuit(vm.cards_played_list[0].cardindex);
                    for (var i=0; i < vm.dummyhand.length; i++) {
                        console.log('autoPlayDummyCard:', i, vm.dummyhand[i], lead_suit, vm.getSuit(vm.dummyhand[i]));
                        if (vm.getSuit(vm.dummyhand[i]) == lead_suit) {
                            console.log('autoPlayDummyCard: playing in suit', i, vm.dummyhand[i]);
                            vm.playDummyCard(i);
                            return;
                        }
                    }
                }
                // otherwise play a random card
                if (vm.dummyhand.length > 0) {
                    console.log('autoPlayDummyCard: playing first card', vm.dummyhand[0]);
                    //vm.playDummyCard(0);
                    vm.playDummyCard(Math.floor(Math.random() * vm.dummyhand.length));
                }
            },

            // vue state management for disconnect recovery
            saveState: function() {
                const key = 'state_' + this.name;
                this.saved_at = new Date().getTime();
                this.show_debug_menu = false;

                // save open modals
                var open_modals = [];
                $('.modal').each(function(idx, elt) {
                    if ($(elt).is(':visible')) open_modals.push(elt.id);
                });
                this.open_modals = open_modals;

                localStorage[key] = JSON.stringify(this._data);
            },
            removeState: function() {
                const key = 'state_' + this.name;
                localStorage.removeItem(key);
            },
            restoreState: function() {
                const key = 'state_' + this.name;
                if (!(key in localStorage)) return;
                const saved_state = JSON.parse(localStorage[key]);

                // expire aged-out state
                const now = new Date().getTime();
                if (now > saved_state.saved_at + (5 * 60 * 1000)) {
                    this.removeState();
                    return;
                }

                for (var field in saved_state) this[field] = saved_state[field];

                // reopen the modals
                window.setTimeout(function() {
                    console.log('opening modals');
                    console.log('open modals:', vm.open_modals);
                    for (var i=0; i < vm.open_modals.length; i++) {
                        var id = vm.open_modals[i]
                        console.log('queueing modal:', i, id);
                        window.setTimeout(function() {
                            console.log('showing modal:', id);
                            $('#' + id).modal('show');
                        }, 50 * (i+1));
                    }
                }, 200);
            },
            showLocalStorage: function() {
                for (var key in localStorage) console.log('*****', key, JSON.stringify(localStorage[key]));
            },
            clearLocalStorage: function() {
                localStorage.clear();
            },
            saveSettings: function() {
                const key = 'settings_' + this.name;
                const settings = {
                    two_click_bids: this.two_click_bids,
                    two_click_plays: this.two_click_plays,
                    alternate_deck: this.alternate_deck,
                    mute: this.mute,
                    announce_presets: JSON.stringify(this.announce_presets),
                    alert_presets: JSON.stringify(this.alert_presets),
                    background: this.background
                }
                localStorage[key] = JSON.stringify(settings);
            },
            loadSettings: function() {
                const key = 'settings_' + this.name;
                if (key in localStorage) {
                    const settings = JSON.parse(localStorage[key]);
                    this.two_click_bids = settings.two_click_bids;
                    this.two_click_plays = settings.two_click_plays;
                    this.alternate_deck = settings.alternate_deck;
                    this.mute = settings.mute;
                    if ('announce_presets' in settings) {
                        this.announce_presets = JSON.parse(settings.announce_presets);
                    }
                    if ('alert_presets' in settings) {
                        this.alert_presets = JSON.parse(settings.alert_presets);
                    }
                    try {
                        if (('background' in settings) && ('hsb' in settings.background) && ('b' in settings.background.hsb)) {
                            this.setBackgroundColor(settings.background.hsb, settings.background.hex, settings.background.rgb);
                        }
                    }
                    catch(err) {
                        console.log('error loading settings:', err);
                    }
                }
            },
            setBackgroundColor: function(hsb, hex, rgb) {
                try {
                    this.background = {hsb: hsb, hex: hex, rgb: rgb};
                    $('body').css('backgroundColor', '#' + hex);
                    if (hsb.b > 50) {
                        $('body').css('color', 'black');
                    }
                    else {
                        $('body').css('color', 'white');
                    }
                    $('#left_header, #center_header, #right_header, #left_footer, #center_footer, #right_footer').css('color', 'white');
                }
                catch(err) {
                    console.log('error in setBackgroundColor:', err);
                }
            },

            initPlayedCardLayering: function(direction) {
                zs = played_card_z_index[direction];
                console.log(zs);
                for (var elt in zs) {
                    console.log(elt, zs[elt]);
                    $('#' + elt).css('zIndex', zs[elt]);
                }
            }

        },
        watch: {
        }
    });
</script>
</body></html>
